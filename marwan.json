require 'sketchup.rb'
require 'net/http'
require 'uri'
require 'json'
require 'securerandom'
require 'open-uri'
require 'tmpdir'
require 'base64'
require 'tempfile'
require 'digest'
require 'fileutils'

module MHDESIGN
  PLUGIN_NAME = "MHDESIGN"
  
  # ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  ENCODED_API_URL = "aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL21hcndhbmFkZWxldGFoYW4tc3Vkby9BUElxMjMvcmVmcy9oZWFkcy9tYWluL2VtYWlsLmpzb24="
  API_URL = Base64.decode64(ENCODED_API_URL)

  COMPONENTS = begin
    url = "https://mahmouddesign.com/SKETCHUP/components-V4.json"
    json_raw = URI.open(url).read
    json_data = JSON.parse(json_raw)
    decoded_json = Base64.decode64(json_data["data"])
    JSON.parse(decoded_json, symbolize_names: true)
  rescue => e
    UI.messagebox("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª: #{e.message}")
    []
  end

  # ==== ÙØ¦Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ====
  class ComponentPlacer
    def initialize(definition, name)
      @definition = definition
      @name = name
      @ip = Sketchup::InputPoint.new
    end

    def onMouseMove(flags, x, y, view)
      @ip.pick(view, x, y)
      view.invalidate
    end

    def draw(view)
      return unless @ip.valid?
      tr = Geom::Transformation.new(@ip.position)
      view.draw(GL_LINE_STRIP, [@ip.position])
      begin
        pts = @definition.bounds.corner(0..7).map { |pt| pt.transform(tr) }
        view.draw(GL_POLYGON, pts)
      rescue
      end
    end

    def onLButtonDown(flags, x, y, view)
      if @ip.valid?
        tr = Geom::Transformation.new(@ip.position)
        instance = Sketchup.active_model.entities.add_instance(@definition, tr)
        Sketchup.active_model.selection.clear
        Sketchup.active_model.selection.add(instance)
        Sketchup.active_model.tools.pop_tool
        Sketchup.send_action("selectMoveTool:")
      end
    end
  end

  def self.get_device_id
    prefs = Sketchup.read_default(PLUGIN_NAME, "device_id")
    return prefs unless prefs.nil? || prefs.empty?
    id = SecureRandom.uuid
    Sketchup.write_default(PLUGIN_NAME, "device_id", id)
    id
  end

  # ==== ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ====
  def self.activate(force_prompt = true)
    email = Sketchup.read_default(PLUGIN_NAME, "email") || ""
    license = Sketchup.read_default(PLUGIN_NAME, "license") || ""

    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø£Ùˆ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©ØŒ Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    if force_prompt || email.empty? || license.empty?
      input = UI.inputbox(["Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"], [email, license], "ØªÙØ¹ÙŠÙ„ MHDESIGN")
      return unless input
      email, license = input
    end

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± API
    valid = verify_credentials(email, license)

    if valid
      Sketchup.write_default(PLUGIN_NAME, "email", email)
      Sketchup.write_default(PLUGIN_NAME, "license", license)
      Sketchup.write_default(PLUGIN_NAME, "activated_once", true)
      UI.messagebox("Ù…Ø¨Ø±ÙˆÙƒ ÙŠØ§ Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø´ØºØ§Ù„Ø©\nØªÙ… Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø±ÙˆØ§Ù† Ø¹Ø§Ø¯Ù„") if force_prompt
      true
    else
      UI.messagebox("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙ„Ø· Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© ØªØ§Ù†ÙŠØ© ÙŠØ§ Ù‡Ù†Ø¯Ø³Ø© Ø§Ùˆ ÙƒÙ„Ù… 01204279606") if force_prompt
      false
    end
  rescue => e
    if Sketchup.read_default(PLUGIN_NAME, "activated_once")
      true
    else
      UI.messagebox("ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: #{e.message}") if force_prompt
      false
    end
  end

  # Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  def self.verify_credentials(email, license)
    begin
      uri = URI.parse(API_URL)
      http = Net::HTTP.new(uri.host, uri.port)
      http.use_ssl = true if uri.scheme == 'https'
      
      request = Net::HTTP::Get.new(uri)
      response = http.request(request)
      
      if response.is_a?(Net::HTTPSuccess)
        # ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© (Base64)
        encoded_data = response.body.strip
        decoded_data = Base64.decode64(encoded_data)
        data = JSON.parse(decoded_data)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµÙÙˆÙØ©
        if data.is_a?(Array)
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
          user = data.find do |user| 
            user_email = user["email"]
            user_password = user["password"] 
            user_email == email && user_password == license
          end
          return !user.nil?
        else
          UI.messagebox("ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­")
          return false
        end
      else
        UI.messagebox("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: #{response.code}")
        return false
      end
      
    rescue JSON::ParserError => e
      UI.messagebox("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: #{e.message}")
      return false
    rescue => e
      UI.messagebox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: #{e.message}")
      return false
    end
  end

  def self.activated?
    email = Sketchup.read_default(PLUGIN_NAME, "email")
    license = Sketchup.read_default(PLUGIN_NAME, "license")
    !email.to_s.empty? && !license.to_s.empty?
  end

  def self.show_library
    # ==== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙØ¹ÙŠÙ„ ====
    unless activate(false)
      activate(true)
      return
    end
    # ==== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ ====

    dlg = UI::HtmlDialog.new({
      :dialog_title => "Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª",
      :preferences_key => "mhdesign_library",
      :scrollable => true,
      :resizable => true,
      :width => 800,
      :height => 650
    })

    categories = COMPONENTS.map { |c| c[:category] }.uniq

    html = <<-HTML
    <html><head>
      <meta charset="UTF-8">
      <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
      <style>
        body {font-family:'Tajawal',sans-serif;margin:0;background:#f9f9f9;padding:0 20px 40px;direction:rtl;}
        header {display:flex;align-items:center;justify-content:space-between;padding:20px 0;}
        header img {height:50px;border-radius:50%;}
        header h2 {margin:0;font-size:24px;color:#2e7d32;}
        .menu-toggle {cursor:pointer;font-size:28px;user-select:none;}
        .filter {display:none;margin-bottom:20px;}
        .filter select {font-size:16px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;}
        .grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;}
        .card {background:white;border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);text-align:center;transition:transform 0.3s ease,box-shadow 0.3s ease;}
        .card:hover {transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,0.12);}
        img.component-img {width:100%;height:200px;object-fit:cover;border-radius:8px;}
        h4 {margin:10px 0 5px;font-size:17px;color:#333;}
        p {font-size:13px;color:#666;margin:0;}
        button {margin-top:10px;padding:6px 14px;background:#43a047;color:white;border:none;border-radius:5px;cursor:pointer;transition:background 0.3s;}
        button:hover {background:#2e7d32;}
        footer {margin-top:40px;text-align:center;font-size:12px;color:#999;}
      </style>
    </head>
    <body oncontextmenu="return false">
      <header>
        <img src="https://mahmouddesign.com/SKETCHUP/components/logo.jpeg" alt="Logo" />
        <h2>Ù…ÙƒØªØ¨Ø© Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø±ÙˆØ§Ù† Ø¹Ø§Ø¯Ù„</h2>
        <div class="menu-toggle" onclick="toggleMenu()">â˜°</div>
      </header>

      <div class="filter" id="filter-box">
        <label>
          ğŸ” ØªØµÙÙŠØ© Ø­Ø³Ø¨:
          <select id="category" onchange="filterComponents()">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
            #{categories.map { |cat| "<option value='#{cat}'>#{cat}</option>" }.join}
          </select>
        </label>
      </div>

      <div id="components" class="grid"></div>

      <footer>
        ØªÙ… Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ… Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø±ÙˆØ§Ù† Ø¹Ø§Ø¯Ù„</b> Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…: <b>01204279606</b><br>
        ğŸ“ Ù„Ù„ØªÙˆØ§ØµÙ„: <b>01204279606</b>
      </footer>

      <script>
function loadComponent(comp){sketchup.loadComponentByData(JSON.stringify(comp));}
document.addEventListener('contextmenu', e=>e.preventDefault());
const allComponents=#{COMPONENTS.to_json};
function render(c){let h="";c.forEach(x=>{h+=`<div class="card"><img class="component-img" src="${x.image}" /><h4>${x.name}</h4><p>${x.desc}</p><button onclick='loadComponent(${JSON.stringify(x)})'>Ø¥Ø¯Ø±Ø§Ø¬</button></div>`});document.getElementById("components").innerHTML=h;}
function filterComponents(){const cat=document.getElementById("category").value;if(cat==="all")render(allComponents);else render(allComponents.filter(c=>c.category===cat));}
function toggleMenu(){const b=document.getElementById("filter-box");b.style.display=(b.style.display==="block")?"none":"block";}
window.onload=()=>filterComponents();
      </script>
    </body></html>
    HTML

    dlg.set_html(html)

    dlg.add_action_callback("loadComponentByData") do |_, comp_json|
      comp = JSON.parse(comp_json, symbolize_names: true)
      url = URI.parse(comp[:url])
      hash_name = Digest::SHA256.hexdigest(url.to_s)[0..16] + ".skp"
      cache_dir = File.join(Dir.tmpdir, "mhdesign_cache_1")
      FileUtils.mkdir_p(cache_dir)
      local_path = File.join(cache_dir, hash_name)

      unless File.exist?(local_path)
        progress = UI::HtmlDialog.new({
          :dialog_title => "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
          :preferences_key => "mhdesign_progress",
          :scrollable => false,
          :resizable => false,
          :width => 300,
          :height => 150
        })

        progress.set_html <<-HTML
          <html><head>
            <meta charset="UTF-8">
            <style>
              body { font-family: 'Tajawal', sans-serif; text-align: center; margin: 0; padding: 20px; direction: rtl; }
              h3 { margin: 10px 0; }
              #progress-bar { width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; margin-top: 10px; }
              #progress-fill { height: 100%; width: 0%; background: #4caf50; transition: width 0.2s ease; }
              #percent { margin-top: 8px; font-size: 14px; }
            </style>
          </head><body>
            <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†...</h3>
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div id="percent">0%</div>
          </body></html>
        HTML

        progress.show

        UI.start_timer(0.3, false) do
          begin
            content_length = nil
            tempfile = Tempfile.new("mhcomponent")

            URI.open(url,
              content_length_proc: ->(len) { content_length = len },
              progress_proc: ->(bytes) {
                percent = content_length ? ((bytes.to_f / content_length) * 100).to_i : 0
                progress.execute_script("document.getElementById('progress-fill').style.width = '#{percent}%'")
                progress.execute_script("document.getElementById('percent').innerText = '#{percent}%'")
              }
            ) do |remote_file|
              IO.copy_stream(remote_file, tempfile)
            end

            tempfile.close
            FileUtils.mv(tempfile.path, local_path)
            progress.close if progress.visible?

            if File.exist?(local_path) && File.size(local_path) > 0
              definition = Sketchup.active_model.definitions.load(local_path, allow_newer: true)
              if definition
                instance = Sketchup.active_model.place_component(definition)
                UI.messagebox("ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…ÙƒÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­") unless instance
              else
                UI.messagebox("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†")
              end
            else
              UI.messagebox("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù")
            end

          rescue => e
            tempfile.close if tempfile
            tempfile.unlink if tempfile
            progress.close if progress.visible?
            UI.messagebox("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†: #{e.message}")
          end
        end
      else
        begin
          if File.exist?(local_path) && File.size(local_path) > 0
            definition = Sketchup.active_model.definitions.load(local_path, allow_newer: true)
            if definition
              instance = Sketchup.active_model.place_component(definition)
              UI.messagebox("ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…ÙƒÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­") unless instance
            else
              UI.messagebox("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†")
            end
          else
            UI.messagebox("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ÙØ§Ø±Øº")
          end
        rescue => e
          UI.messagebox("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†: #{e.message}")
        end
      end
    end

    dlg.add_action_callback("clearComponentCache") do |_|
      begin
        cache_dir = File.join(Dir.tmpdir, "mhdesign_cache_1")
        if File.directory?(cache_dir)
          FileUtils.rm_rf(cache_dir)
        end
        UI.messagebox("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ù†Ø¬Ø§Ø­.")
      rescue => e
        UI.messagebox("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©: #{e.message}")
      end
    end
    dlg.show
  end

  unless file_loaded?(__FILE__)
    UI.menu("Plugins").add_item("#{PLUGIN_NAME} - ØªÙØ¹ÙŠÙ„") { activate(true) }
    UI.menu("Plugins").add_item("#{PLUGIN_NAME} - Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ") { UI.messagebox("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ:\\n" + get_device_id) }
    UI.menu("Plugins").add_item("MHDESIGN - Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©") do
      cache_dir = File.join(Dir.tmpdir, "mhdesign_cache_1")
      if File.directory?(cache_dir)
        FileUtils.rm_rf(cache_dir)
      end
      UI.messagebox("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ù†Ø¬Ø§Ø­.")
    end

    toolbar = UI::Toolbar.new(PLUGIN_NAME)
    cmd = UI::Command.new("Ù…ÙƒØªØ¨Ø© #{PLUGIN_NAME}") { show_library }

    icon_path = File.join(PLUGIN_DIR, "icon.png") rescue
